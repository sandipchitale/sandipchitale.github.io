<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Yin Yang Gimbal Visualization</title>
    <style>
      body {
        margin: 0;
        overflow: hidden;
        background-color: #1a1a1a;
        font-family: "Inter", sans-serif;
        color: #ffffff;
      }
      #info {
        position: absolute;
        top: 20px;
        left: 20px;
        background: rgba(0, 0, 0, 0.7);
        padding: 20px;
        border-radius: 12px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        pointer-events: auto;
      }
      h1 {
        margin: 0 0 15px 0;
        font-size: 1.2rem;
        font-weight: 600;
        letter-spacing: 0.5px;
      }
      .control-group {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .control-item {
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
      }
      input[type="checkbox"] {
        accent-color: #4caf50;
        width: 18px;
        height: 18px;
        cursor: pointer;
      }
      label {
        font-size: 0.9rem;
        cursor: pointer;
        user-select: none;
      }
      #status {
        margin-top: 15px;
        font-size: 0.8rem;
        color: #888;
        font-style: italic;
      }
      #loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 1.5rem;
        font-weight: bold;
        color: #4caf50;
        pointer-events: none;
      }
    </style>
    <!-- Import maps polyfill -->
    <script
      async
      src="https://unpkg.com/es-module-shims@1.8.0/dist/es-module-shims.js"
    ></script>

    <script type="importmap">
      {
        "imports": {
          "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
          "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
      }
    </script>
  </head>
  <body>
    <div id="loading">Loading Models...</div>
    <div id="info">
      <h1>Yin Yang Gimbal</h1>
      <div class="control-group">
        <div class="control-item">
          <input type="checkbox" id="toggle-yin" checked />
          <label for="toggle-yin">Show Yin Rotor</label>
        </div>
        <div class="control-item">
          <input type="checkbox" id="toggle-yang" checked />
          <label for="toggle-yang">Show Yang Rotor</label>
        </div>
        <div class="control-item">
          <input type="checkbox" id="toggle-frame-left" checked />
          <label for="toggle-frame-left">Show Left Frame</label>
        </div>
        <div class="control-item">
          <input type="checkbox" id="toggle-frame-right" checked />
          <label for="toggle-frame-right">Show Right Frame</label>
        </div>
        <div class="control-item">
          <input type="checkbox" id="toggle-anim" checked />
          <label for="toggle-anim">Animate (Click Model to Toggle)</label>
        </div>
      </div>
      <div id="status">Click anywhere on the model to pause/resume.</div>
    </div>

    <script type="module">
      import * as THREE from "three";
      import { OrbitControls } from "three/addons/controls/OrbitControls.js";
      import { STLLoader } from "three/addons/loaders/STLLoader.js";

      // Scene Setup
      const scene = new THREE.Scene();
      scene.background = new THREE.Color(0x1a1a1a);
      // Add some fog for depth
      scene.fog = new THREE.Fog(0x1a1a1a, 20, 100);

      const camera = new THREE.PerspectiveCamera(
        45,
        window.innerWidth / window.innerHeight,
        0.1,
        1000
      );
      camera.position.set(30, 20, 30);

      const renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      document.body.appendChild(renderer.domElement);

      // Controls
      const controls = new OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.05;

      // Lighting
      const ambientLight = new THREE.AmbientLight(0x404040, 2); // Soft white light
      scene.add(ambientLight);

      const dirLight = new THREE.DirectionalLight(0xffffff, 2);
      dirLight.position.set(10, 20, 10);
      scene.add(dirLight);

      const backLight = new THREE.DirectionalLight(0x445566, 1);
      backLight.position.set(-10, 5, -10);
      scene.add(backLight);

      // Materials
      const materialYin = new THREE.MeshStandardMaterial({
        color: 0xffffff,
        roughness: 0.4,
        metalness: 0.1,
      });
      const materialYang = new THREE.MeshStandardMaterial({
        color: 0x222222,
        roughness: 0.4,
        metalness: 0.1,
      });
      const materialFrame = new THREE.MeshStandardMaterial({
        color: 0x888888,
        roughness: 0.7,
        metalness: 0.5,
      });

      // Groups for rotation
      const yinGroup = new THREE.Group();
      const yangGroup = new THREE.Group();
      const frameGroup = new THREE.Group();
      // Initial rotation handled by animation loop now
      scene.add(yinGroup);
      scene.add(yangGroup);
      scene.add(frameGroup);

      // Loaders
      const loader = new STLLoader();
      let loadedCount = 0;
      const totalModels = 4;

      function checkLoaded() {
        loadedCount++;
        if (loadedCount === totalModels) {
          document.getElementById("loading").style.display = "none";
          animate();
        }
      }

      function loadSTL(path, material, group, name) {
        loader.load(
          path,
          function (geometry) {
            geometry.computeVertexNormals();
            const mesh = new THREE.Mesh(geometry, material);
            mesh.name = name;
            group.add(mesh);
            checkLoaded();
          },
          undefined,
          function (error) {
            console.error("Error loading " + path, error);
          }
        );
      }

      // Load Models
      // Assuming files are in the same directory
      loadSTL("./yin.stl", materialYin, yinGroup, "yin");
      loadSTL("./yang.stl", materialYang, yangGroup, "yang");
      loadSTL("./frame_left.stl", materialFrame, frameGroup, "frame_left");
      loadSTL("./frame_right.stl", materialFrame, frameGroup, "frame_right");

      // Animation State
      let isAnimating = true;
      const rotationSpeed = 0.01;

      // UI Logic
      const toggleVisibility = (id, objectName) => {
        document.getElementById(id).addEventListener("change", (e) => {
          if (objectName === "yin" || objectName === "yang") {
            if (objectName === "yin") yinGroup.visible = e.target.checked;
            if (objectName === "yang") yangGroup.visible = e.target.checked;
          } else {
            const mesh = frameGroup.children.find((c) => c.name === objectName);
            if (mesh) mesh.visible = e.target.checked;
          }
        });
      };

      toggleVisibility("toggle-yin", "yin");
      toggleVisibility("toggle-yang", "yang");
      toggleVisibility("toggle-frame-left", "frame_left");
      toggleVisibility("toggle-frame-right", "frame_right");

      const animToggle = document.getElementById("toggle-anim");
      animToggle.addEventListener("change", (e) => {
        isAnimating = e.target.checked;
        document.getElementById("status").textContent = isAnimating
          ? "Animation running..."
          : "Animation paused.";
      });

      // Click to toggle
      window.addEventListener("mousedown", (event) => {
        // Only toggle if not clicking on UI
        if (event.target.closest("#info")) return;

        isAnimating = !isAnimating;
        animToggle.checked = isAnimating;
        document.getElementById("status").textContent = isAnimating
          ? "Animation running..."
          : "Animation paused.";
      });

      // Resize Handler
      window.addEventListener("resize", onWindowResize, false);
      function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      }

      // Animation Loop
      function animate() {
        requestAnimationFrame(animate);

        if (isAnimating) {
          // Rotate Yin around Z axis
          yinGroup.rotation.z += rotationSpeed;

          // Rotate Yang around Y axis (reversed relative to Yin)
          yangGroup.rotation.y = -yinGroup.rotation.z;
        }

        controls.update();
        renderer.render(scene, camera);
      }
    </script>
  </body>
</html>
